# DevContainerからエミュレータへの通信経路

## 1. ADB接続の経路（通常のadbコマンド）

```
DevContainer（WSL2内）
│
├─ adbコマンド実行
│  └─ /opt/android-sdk/platform-tools/adb（スクリプト）
│     └─ host.docker.internal:5037 に接続
│
└─ WSL2ネットワーク
   │
   └─ Windowsネットワーク
      │
      └─ ADBサーバー（Windows側、ポート5037）
         │
         └─ エミュレータ内のADBデーモン（adbd）
```

## 2. ホットリロード（VM Service）の通信経路

### 問題：通常の経路では接続できない

```
DevContainer内のFlutter
│
├─ VM Service（ポート8181）を起動
│  └─ DevContainer内の8181ポートで待機
│
└─ エミュレータ内のVM Service（ポート8181）に接続しようとする
   │
   └─ ❌ 複雑なネットワーク経路で接続できない
```

### 解決：adb reverseでトンネルを作成

```
DevContainer内のFlutter
│
├─ VM Service（ポート8181）を起動
│  └─ DevContainer内の8181ポートで待機
│
└─ adb reverse tcp:8181 tcp:8181 でトンネル作成
   │
   ├─ エミュレータ内の8181ポート
   │  └─ ↓ トンネル経由
   │
   └─ DevContainer内の8181ポート
      └─ ✅ 接続成功
```

## 3. 詳細な通信経路（adb reverse使用時）

```
┌─────────────────────────────────────────────────────────┐
│ DevContainer（WSL2内）                                    │
│                                                           │
│  Flutter VM Service                                       │
│  └─ ポート8181で待機                                      │
│                                                           │
│  adbコマンド                                              │
│  └─ host.docker.internal:5037 に接続                     │
└─────────────────────────────────────────────────────────┘
         │
         │ Dockerネットワーク
         │
         ▼
┌─────────────────────────────────────────────────────────┐
│ WSL2                                                      │
│                                                           │
│  host.docker.internal → Windows側に転送                  │
└─────────────────────────────────────────────────────────┘
         │
         │ WSL2 → Windows ブリッジ
         │
         ▼
┌─────────────────────────────────────────────────────────┐
│ Windows（ホスト）                                         │
│                                                           │
│  ADBサーバー（ポート5037）                                │
│  └─ エミュレータと通信                                    │
│                                                           │
│  adb reverse tcp:8181 tcp:8181 のトンネル               │
│  └─ エミュレータ内の8181 ↔ DevContainer内の8181          │
└─────────────────────────────────────────────────────────┘
         │
         │ ADBプロトコル
         │
         ▼
┌─────────────────────────────────────────────────────────┐
│ Androidエミュレータ                                       │
│                                                           │
│  ADBデーモン（adbd）                                      │
│  └─ ADBサーバーと通信                                     │
│                                                           │
│  VM Service（ポート8181）                                │
│  └─ Flutterアプリのデバッグ用                             │
│                                                           │
│  adb reverse トンネル                                     │
│  └─ エミュレータ内の8181 → DevContainer内の8181           │
└─────────────────────────────────────────────────────────┘
```

## 4. 通信の流れ（ステップバイステップ）

### ADB接続の場合

1. DevContainer内で`adb devices`を実行
2. `/opt/android-sdk/platform-tools/adb`（スクリプト）が実行される
3. `host.docker.internal:5037`に接続
4. WSL2経由でWindows側のADBサーバーに到達
5. ADBサーバーがエミュレータ内のADBデーモンと通信
6. デバイス一覧が返される

### ホットリロード（VM Service）の場合

1. DevContainer内で`flutter run`を実行
2. Flutter VM ServiceがDevContainer内のポート8181で起動
3. `adb reverse tcp:8181 tcp:8181`でトンネルを作成
   - エミュレータ内の8181 → DevContainer内の8181
4. エミュレータ内のVM Serviceがエミュレータ内のポート8181で起動
5. トンネル経由でDevContainer内のVM Serviceと接続
6. ホットリロードが有効になる

## 5. なぜadb reverseが必要か

- **通常のネットワーク経路**：DevContainer → WSL2 → Windows → エミュレータ
  - 複雑すぎてVM Service接続がうまくいかない
- **adb reverseトンネル**：エミュレータ内の8181 ↔ DevContainer内の8181
  - ADBサーバーが中継してくれるため、直接接続できる
  - ホットリロードが正常に動作する

